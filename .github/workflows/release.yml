name: üßæ release

on: # –ø–æ–º–µ–Ω—è—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –ø–æ—Å–ª–µ –æ—Ç–ª–∞–¥–∫–∏
  push:
#    tags:
#      - "v[0-9]+"
permissions:
  contents: read
  issues: write
env:
  COMMIT_LIST: __env_commit__
  PREV_TAG: __env_tag__
  RELEASE_VERSION: __env_tag__
  RELEASE_COMMIT:

jobs:
  changelog:
    name: üèÇ –ù–∞—á–∞—Ç —Ä–µ–ª–∏–∑
    runs-on: ubuntu-latest
    # if: ${{ github.ref_type  == 'tag' }}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: üè∑Ô∏è –ü–æ–ª—É—á–∏—Ç—å –∏–º—è —Ç–µ–≥–∞
        run: |
          echo "RELEASE_VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV
      #          echo ${GITHUB_REF#refs/*/}
      #          echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: üîç –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–ª–∏–∑–Ω—ã–π —Ç–µ–≥
        run: |
          echo "PREV_TAG=$(git describe --abbrev=0 --tags HEAD~6)" >> $GITHUB_ENV
          echo ${{ env.PREV_TAG }}
      - name: ‚öíÔ∏è –ö–æ–º–º–∏—Ç—ã –º–µ–∂–¥—É —Ä–µ–ª–∏–∑–∞–º–∏
        id: collect-commits
        run: |
          echo "COMMIT_LIST<<EOF" >> $GITHUB_ENV
          COMMIT_LIST=$(git log --pretty=format:"%s" ${{ env.RELEASE_VERSION }} ^${{ env.PREV_TAG }})
          echo "$COMMIT_LIST" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_DATE: ${{ github.event.head_commit.timestamp }}
          COMMITS: ${{ env.COMMIT_LIST }}
        with:
          update_existing: true
  add-branch:
    name: üå≥ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ç–∫–∏
    needs: changelog
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: üîç –£–¥–∞–ª–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏
        run: | # git checkout master
          git branch -D release-${{ env.RELEASE_VERSION }}
          git push origin --delete release-${{ env.RELEASE_VERSION }}
          git checkout -b release-${{ env.RELEASE_COMMIT }} ${{ env.RELEASE_COMMIT }}
          git push origin release-${{ env.RELEASE_VERSION }}

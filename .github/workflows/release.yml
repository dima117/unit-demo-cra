name: Release

on:
  push:
    tags:
      - v*

jobs:
  build:
    name: Create Release
    permissions:
      contents: write
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1
        with:
         token: ${{ github.token }}
         tag: ${{ github.ref_name }}
         writeToFile: false

      - name: Create Release
        uses: ncipollo/release-action@v1.12.0
        with:
          allowUpdates: true
          draft: false
          makeLatest: true
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changes }}
          token: ${{ github.token }}

      - name: Add issue to project
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ steps.changelog.outputs.changes }}
          ACTOR: ${{ github.actor }}
          ACTION_REF: ${{ github.ref_name }}
          DATE: ${{ github.event.repository.updated_at}}
          ACTIONS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  quality:
    name: Check quality
    uses: ./.github/workflows/quality.yml

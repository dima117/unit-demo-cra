name: Release
on:
  push:
    tags:
      - 'v\d+'

jobs:
  build:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.issue.outputs.issue }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get Current Tag
        id: get_tag
        run: |
          current_tag=$(echo "${{ github.ref }}" | awk -F/ '{print $3}')
          prev_tag=$(git describe --tags --abbrev=0 ${current_tag}^)
          echo "current_tag=$current_tag">>"$GITHUB_ENV"
          echo "prev_tag=$prev_tag">>"$GITHUB_ENV"
      - name: Get commit date
        run: echo "commit_date=$(git log -1 --format=%cd)">>"$GITHUB_ENV"
      - name: Git log
        id: git-log
        run: |
          git_log=$(git log --pretty=format:"- %s" "${{ env.prev_tag }}..${{ env.current_tag }}")
          echo "::set-output name=git-log::$git_log"
      - name: Create Branch
        run: |
          BRANCH_NAME=release-${{ env.current_tag }}
          git checkout -b $BRANCH_NAME
          git push -u origin $BRANCH_NAME
      - name: Create issue
        uses: imjohnbo/issue-bot@v3
        id: issue-bot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          labels: 'RELEASE'
          title: ${{ env.current_tag }}
          body: |
            Author: ${{ github.actor }}
            Date: ${{ env.commit_date }}
            Changelog:
              ${{ steps.git-log.outputs.git-log }}
          pinned: false
          close-previous: false
      - name: Output issue number
        id: issue
        run: |
          echo "issue=${{ steps.issue-bot.outputs.issue-number }}">>"$GITHUB_OUTPUT"
  test-workflow:
    uses: ./.github/workflows/pr-test.yaml
  build-and-deploy:
    needs: test-workflow
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install and Build
        run: |
          npm ci
          npm run build
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
  close-issue:
    runs-on: ubuntu-latest
    needs: [build, build-and-deploy]
    steps:
      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{needs.build.outputs.output1}}
          comment: |
            Tests passed and build successfully uploaded to gh-pages

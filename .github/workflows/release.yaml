name: Release
on:
  push:
    tags:
      - 'v\d+'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get Current Tag
        id: get_tag
        run: |
          current_tag=$(echo "${{ github.ref }}" | awk -F/ '{print $3}')
          tag_number=$(echo $current_tag | sed 's/[^0-9]*//g')
          prev_tag=$((tag_number - 1))
          prev_tag="v$prev_tag"
          echo "current_tag=$current_tag">>"$GITHUB_ENV"
          echo "prev_tag=$prev_tag">>"$GITHUB_ENV"
      - name: Get commit date
        run: echo "commit_date=$(git log -1 --format=%cd)">>"$GITHUB_ENV"
      - name: Create Branch
        run: |
         BRANCH_NAME=release-${{ env.current_tag }}
         git checkout -b $BRANCH_NAME
         git push -u origin $BRANCH_NAME
      - name: Create Issue
        run: |
         git_log=$(git log --pretty=oneline --no-merges "${{ env.prev_tag }}..${{ env.current_tag }}")
         # Set the issue title and body
         ISSUE_TITLE="${{ env.current_tag }}"
         ISSUE_BODY="Author: '$author_name'\n\nDate: ${{ env.commit_date }}\n\nChangelog:\n'$git_log'"
   
         # Fetch the repository information
         REPO_OWNER="${{ github.repository_owner }}"
         REPO_NAME="${{ github.repository }}"
         API_URL="https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues"
   
         # Create the issue using the GitHub REST API
         curl -X POST \
           -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
           -H "Accept: application/vnd.github.v3+json" \
           "$API_URL" \
           -d '{
             "title": "'"$ISSUE_TITLE"'",
             "body": "'"$ISSUE_BODY"'",
             "labels": ["RELEASE"]
           }'

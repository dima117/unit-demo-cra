name: Release
on:
  push:
    tags:
      - 'v\d+'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get Current Tag
        id: get_tag
        run: |
          current_tag=$(echo "${{ github.ref }}" | awk -F/ '{print $3}')
          tag_number=$(echo $current_tag | sed 's/[^0-9]*//g')
          prev_tag=$((tag_number - 1))
          prev_tag="v$prev_tag"
          echo "::set-output name=current_tag::$current_tag"
          echo "::set-output name=prev_tag::$prev_tag"

      - name: Get Git Log
        id: git_log
        run: |
          echo $(git branch --list)
          echo $(git tag --list)
          git_log=$(git log --pretty=oneline --no-merges ${{ steps.get_tag.outputs.prev_tag }}..${{ steps.get_tag.outputs.current_tag }})
          echo "::set-output name=git_log::$git_log"

      - name: Create Issue
        run: |
          author_name=$(git log -1 --format='%an')
          response=$(curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
          "title": "New Issue",
          "body": "Author: '$author_name'\n\nDate: $(date +%Y-%m-%d-%H%M%S)\n\nChangelog:\n'${{ steps.get_tag.outputs.git_log }}'",
          "labels": ["RELEASE"]
          }' \
          "https://api.github.com/repos/${{ github.repository }}/issues")
          echo "$response"

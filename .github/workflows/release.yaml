on:
  workflow_dispatch:
  push:
    tags:
      - v[0-9]+
permissions:
  contents: read
  issues: write
jobs:
  release:
    name: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d / -f 3)

      - name: Get previous tag
        id: previoustag
        run: echo "::set-output name=TAGNAME::$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))"

      - name: Set diff
        id: diff
        env:
          LAST_TAG: ${{ steps.previoustag.outputs.TAGNAME }}
          CURRENT_TAG: ${{ steps.get_version.outputs.VERSION }}
        run: |
          echo'DIFF<<EOF' >> $GITHUB_OUTPUT
          diff=$(git log --pretty='%h; author: %cn;  subject:%s'  $LAST_TAG..$CURRENT_TAG)
          echo "$diff" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ steps.get_version.outputs.VERSION }}
          HISTORY: ${{ steps.diff.outputs.diff}}
          PREVIOUS_TAG: ${{ steps.previoustag.outputs.TAGNAME }}
        with:
          update_existing: true
          search_existing: open
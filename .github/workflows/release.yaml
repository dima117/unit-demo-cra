on:
  workflow_dispatch:
  push:
    tags:
      - v[0-9]+
permissions:
  contents: read
  issues: write
jobs:
  release:
    name: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d / -f 3)

      - name: Get previous tag
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 4b825dc642cb6eb9a060e54bf8d69288fbee4904

      - name: Set diff
        id: diff
        env:
          LAST_TAG: ${{ steps.previoustag.outputs.tag }}
        run: |
          git_hash=$(git rev-parse --short "$GITHUB_SHA")
          diff=$(git log --pretty='%h; author: %cn;  subject:%s'  $LAST_TAG..$git_hash | cat)
          echo "DIFF=$diff" >> $GITHUB_OUTPUT
      - uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ steps.get_version.outputs.VERSION }}
          HISTORY: ${{ steps.diff.outputs.diff}}
          PREVIOUS_TAG: ${{ steps.previoustag.outputs.TAGNAME }}
        with:
          update_existing: true
          search_existing: open
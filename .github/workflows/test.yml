name: Tests CI

#on: [ pull_request, workflow_call ]

on:
  pull_request_target:
    types:
      - synchronize
  workflow_run:
    workflows: [ "workflow_call" ]
    types:
      - completed

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        commit: ${{ github.event.pull_request.commits }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
            node-version: 16

      - name: Run tests for commit
        run: |
          git checkout ${{ matrix.commit }}

          npm ci
          npm install --only=dev
          npx playwright install
          npm run build --if-present

          npm run test-ci

          sudo apt-get install xvfb -y
          
          export DISPLAY=:1
          Xvfb :1 -screen 0 1024x768x24 > /dev/null 2>&1 &
          
          xvfb-run npm run e2e-ci
